<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Trip Builder | Experience Ecuador</title>

  <!-- Favicons -->
  <link rel="icon" href="/assets/favicons/favicon.ico" sizes="any">
  <link rel="icon" href="/assets/favicons/favicon.svg" type="image/svg+xml">
  <link rel="apple-touch-icon" href="/assets/favicons/apple-touch-icon.png">
  <link rel="manifest" href="/assets/favicons/site.webmanifest">
  <meta name="theme-color" content="#034EA2">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;800&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

  <!-- styles unchanged -->
  <!-- (your existing <style> block stays exactly the same) -->
</head>

<body>

<!-- HEADER + HERO unchanged -->

<main class="wrap">

  <section class="card builder">
    <h2>Build a custom Ecuador itinerary</h2>
    <p>
      This tool creates a suggested, flexible itinerary based on your preferences.
      It’s designed to guide planning — for full coordination and logistics, we’re happy to help.
    </p>

    <!-- controls unchanged -->
  </section>

  <section class="itinerary">
    <h2 class="section-title">Your suggested itinerary</h2>
    <div id="output" class="hint">
      Select days, regions, and experiences. Then click “Generate itinerary.”
    </div>
  </section>

</main>

<script>
/* ================================
   CORE RULES CONFIG
================================ */
const DAY_CAPACITY_HOURS = 8;

/* ================================
   UTILITIES
================================ */
function clamp(n,min,max){return Math.max(min,Math.min(max,n))}
function pick(arr){return arr[Math.floor(Math.random()*arr.length)]}

/* ================================
   DATA + STATE (unchanged loading)
================================ */
const DATA = { regions:null, experiences:null, blocks:null }
const state = {
  days:5,
  selectedRegionIds:new Set(),
  selectedExperienceIds:new Set()
}

/* ================================
   ITINERARY ENGINE (UPDATED)
================================ */
function generateItinerary(){
  const totalDays = clamp(state.days,1,21)
  const regionIds = Array.from(state.selectedRegionIds)
  const experienceIds = state.selectedExperienceIds

  const allocation = splitDaysByRegion(totalDays, regionIds)
  const usedBlocks = new Set()
  const plan = []
  let dayNumber = 1

  allocation.forEach((chunk, chunkIndex)=>{
    for(let d=0; d<chunk.days; d++){
      let remaining = DAY_CAPACITY_HOURS
      const dayBlocks = []
      const suggestions = []

      const isTransferDay = d===0 && chunkIndex>0

      const candidates = DATA.blocks.blocks.filter(b=>{
        if(b.region_id!==chunk.region_id) return false
        if(usedBlocks.has(b.id)) return false
        return b.experiences.some(e=>experienceIds.has(e))
      })

      candidates.sort((a,b)=>a.duration_hours-b.duration_hours)

      for(const block of candidates){
        if(block.duration_hours>DAY_CAPACITY_HOURS){
          // multi-day block
          dayBlocks.push(block)
          usedBlocks.add(block.id)
          remaining = 0
          break
        }

        if(block.duration_hours<=remaining){
          dayBlocks.push(block)
          usedBlocks.add(block.id)
          remaining -= block.duration_hours
        } else if(remaining>=2){
          suggestions.push(block)
        }

        if(remaining<=0) break
      }

      plan.push({
        day:dayNumber++,
        region_id:chunk.region_id,
        blocks:dayBlocks,
        suggestions,
        transfer:isTransferDay
      })
    }
  })

  return plan
}

/* ================================
   HELPERS
================================ */
function splitDaysByRegion(total, regions){
  const base=Math.floor(total/regions.length)
  let extra=total%regions.length
  return regions.map(r=>{
    const d=base+(extra>0?1:0)
    if(extra>0) extra--
    return {region_id:r,days:d}
  })
}

function regionName(id){
  const r=DATA.regions.regions.find(x=>x.id===id)
  return r?r.name:id
}
function locationName(regionId, locId){
  const r=DATA.regions.regions.find(x=>x.id===regionId)
  if(!r) return ""
  const l=r.locations.find(x=>x.id===locId)
  return l?l.name:""
}
function experienceName(id){
  const e=DATA.experiences.experiences.find(x=>x.id===id)
  return e?e.name:id
}

/* ================================
   RENDERING
================================ */
function renderItinerary(plan){
  const out=document.getElementById("output")
  out.innerHTML=""

  plan.forEach(day=>{
    const card=document.createElement("div")
    card.className="day-card"

    card.innerHTML=`
      <div class="day-title">
        <span>Day ${day.day}: ${regionName(day.region_id)}</span>
        <span class="tag">${day.transfer?"Transfer-friendly":"Suggested plan"}</span>
      </div>
    `

    day.blocks.forEach(b=>{
      card.appendChild(renderBlock(b,day.region_id))
    })

    if(day.suggestions.length){
      const hint=document.createElement("div")
      hint.className="hint"
      hint.innerHTML=`Optional add-on if you have extra energy: <strong>${day.suggestions[0].title}</strong>`
      card.appendChild(hint)
    }

    out.appendChild(card)
  })
}

function renderBlock(block,regionId){
  const div=document.createElement("div")
  div.className="slot"
  const meta=[
    locationName(regionId,block.location_id),
    block.experiences.map(experienceName).join(" · "),
    block.duration_hours+"h"
  ].filter(Boolean).join(" • ")

  div.innerHTML=`
    <h4>${block.time_of_day||"Day"}</h4>
    <div class="title">${block.title}</div>
    <p class="meta">${block.summary}<br><span style="opacity:.9">${meta}</span></p>
  `
  return div
}

/* ================================
   INIT (unchanged loaders)
================================ */
async function loadJSON(p){const r=await fetch(p,{cache:"no-store"});return r.json()}
async function init(){
  const [regions,experiences,blocks]=await Promise.all([
    loadJSON("/assets/data/regions.json"),
    loadJSON("/assets/data/experiences.json"),
    loadJSON("/assets/data/itinerary_blocks.json")
  ])
  DATA.regions=regions
  DATA.experiences=experiences
  DATA.blocks=blocks
}
init()

document.getElementById("generateBtn").onclick=()=>{
  const plan=generateItinerary()
  renderItinerary(plan)
}
</script>

</body>
</html>
