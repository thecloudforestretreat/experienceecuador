<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Partner Application | Experience Ecuador</title>
  <meta name="description" content="Apply to join the Experience Ecuador partner network. Submit your business details in English or Spanish." />
  <meta name="robots" content="noindex,nofollow" />
  <link rel="canonical" href="https://experienceecuador.com/partners/join/" />

  <meta name="theme-color" content="#034EA2" />
  <link rel="stylesheet" href="/assets/css/header.css" />
  <link rel="stylesheet" href="/assets/css/footer.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;800&family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />

  <style>
    :root{
      --brand:#034EA2;
      --ink:#0f2f62;
      --text:#1f2a3a;
      --muted:#64748b;
      --bg:#f6f8fb;
      --card:#ffffff;
      --line: rgba(0,0,0,0.08);
      --shadow: 0 18px 55px rgba(3,78,162,0.12);
      --shadowSoft: 0 14px 34px rgba(3,78,162,0.10);
      --r-xl: 24px;
      --r-lg: 18px;
      --r-md: 14px;
      --max: 980px;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
      background: var(--bg);
    }
    a{ color: inherit; text-decoration: none; }
    img{ max-width:100%; display:block; }

    .wrap{
      max-width: var(--max);
      margin: 0 auto;
      padding: 26px 16px 70px;
    }

    .topRow{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }

    h1{
      margin:0;
      font-family: Montserrat, Inter, sans-serif;
      font-weight: 800;
      letter-spacing: -0.03em;
      color: var(--brand);
      font-size: 26px;
      line-height: 1.1;
    }
    .sub{
      margin: 8px 0 0;
      color: var(--muted);
      line-height: 1.65;
      font-size: 14px;
      font-weight: 650;
      max-width: 92ch;
    }

    .toggle{
      display:inline-flex;
      align-items:center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(3,78,162,0.18);
      background: rgba(255,255,255,0.92);
      color: var(--ink);
      font-weight: 900;
      font-size: 12.5px;
      user-select:none;
      box-shadow: var(--shadowSoft);
    }
    .switch{
      width: 46px;
      height: 28px;
      border-radius: 999px;
      background: rgba(3,78,162,0.14);
      position: relative;
      cursor: pointer;
      border: 1px solid rgba(3,78,162,0.18);
      flex: 0 0 auto;
    }
    .knob{
      position:absolute;
      top: 3px;
      left: 3px;
      width: 22px;
      height: 22px;
      border-radius: 999px;
      background: #fff;
      box-shadow: 0 10px 22px rgba(0,0,0,0.10);
      transition: transform 180ms ease;
    }
    .switch.is-en .knob{ transform: translateX(18px); }

    .card{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--r-xl);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .pad{ padding: 16px; }

    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 12px;
    }
    .row.one{ grid-template-columns: 1fr; }

    label{
      display:block;
      font-weight: 900;
      font-size: 12.5px;
      color: var(--ink);
      margin: 0 0 6px;
    }
    .reqMark{
      color: #b91c1c;
      font-weight: 900;
      margin-left: 6px;
    }
    input, textarea, select{
      width:100%;
      border:1px solid rgba(3,78,162,0.18);
      border-radius: 14px;
      padding: 11px 12px;
      font-size: 14px;
      outline: none;
      background: rgba(255,255,255,0.98);
    }
    textarea{ min-height: 96px; resize: vertical; }

    .help{
      font-size: 12px;
      color: var(--muted);
      font-weight: 650;
      margin-top: 6px;
      line-height: 1.5;
    }

    .pillBox{
      border:1px solid rgba(3,78,162,0.18);
      border-radius: 14px;
      padding: 10px;
      background: rgba(3,78,162,0.03);
      display:flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 999px;
      border:1px solid rgba(3,78,162,0.18);
      background: rgba(255,255,255,0.92);
      font-weight: 900;
      font-size: 12.5px;
      color: var(--ink);
      cursor: pointer;
      user-select:none;
      white-space: nowrap;
    }
    .pill input{ width:auto; margin:0; }

    .callout{
      margin-top: 12px;
      border-radius: 18px;
      border: 1px solid rgba(3,78,162,0.14);
      background: linear-gradient(180deg, rgba(3,78,162,0.06), rgba(3,78,162,0.02));
      padding: 14px;
      box-shadow: var(--shadowSoft);
    }
    .callout h3{
      margin:0 0 6px;
      font-family: Montserrat, Inter, sans-serif;
      font-weight: 800;
      letter-spacing: -0.02em;
      color: var(--ink);
      font-size: 15px;
    }
    .callout p{
      margin:0;
      color: var(--text);
      opacity: .96;
      line-height: 1.6;
      font-size: 13.5px;
      font-weight: 650;
    }
    .callout a{
      color: var(--brand);
      text-decoration: underline;
      text-underline-offset: 3px;
      font-weight: 900;
    }

    .consentRow{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
      padding: 12px;
      border-radius: 14px;
      border:1px solid rgba(3,78,162,0.18);
      background: rgba(255,255,255,0.92);
    }
    .consentRow label{
      margin: 0;
      font-size: 12.8px;
      line-height: 1.5;
      font-weight: 900;
      color: var(--ink);
    }
    .consentRow input{ width:auto; margin-top: 2px; }

    .okBox, .errBox{
      margin-top: 14px;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid rgba(0,0,0,0.08);
      background: rgba(255,255,255,0.92);
      font-weight: 800;
      display:none;
      line-height: 1.55;
      font-size: 13px;
    }
    .okBox{ border-color: rgba(16,185,129,0.35); }
    .errBox{ border-color: rgba(239,68,68,0.35); }

    .actions{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      flex-wrap: wrap;
      padding: 16px;
      border-top: 1px solid var(--line);
      background: rgba(3,78,162,0.02);
    }
    .note{
      font-weight: 800;
      color: var(--ink);
      font-size: 12.5px;
      line-height: 1.45;
      max-width: 62ch;
    }
    .btnRow{ display:flex; gap: 10px; flex-wrap: wrap; align-items:center; }
    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 12px 14px;
      border-radius: 14px;
      font-weight: 900;
      border: 1px solid rgba(3,78,162,0.18);
      background: rgba(255,255,255,0.96);
      color: var(--ink);
      cursor:pointer;
      box-shadow: var(--shadowSoft);
    }
    .btn.primary{
      background: rgba(3,78,162,0.95);
      color:#fff;
      border-color: rgba(3,78,162,0.28);
      box-shadow: 0 18px 40px rgba(3,78,162,0.18);
    }
    .btn:disabled{ opacity: .65; cursor: default; }

    .spinner{
      width: 16px;
      height: 16px;
      border-radius: 999px;
      border: 2px solid rgba(255,255,255,0.45);
      border-top-color: rgba(255,255,255,0.95);
      display:none;
      animation: spin 750ms linear infinite;
    }
    .btn.primary.is-loading .spinner{ display:inline-block; }
    .btn.primary.is-loading .btnText{ opacity:.9; }
    @keyframes spin{ to{ transform: rotate(360deg); } }

    @media (max-width: 860px){
      .row{ grid-template-columns: 1fr; }
      .note{ max-width: none; }
    }
  </style>
</head>

<body>
  <div id="siteHeader"></div>

  <main class="wrap" aria-label="Partner application">
    <div class="topRow">
      <div>
        <h1 data-i18n="title">Partner Application</h1>
        <p class="sub" data-i18n="subtitle">
          Submit your details to be considered for Recommended by Experience Ecuador. You can select multiple regions, locations, and experiences.
        </p>
      </div>

      <div class="toggle" aria-label="Language toggle">
        <span>ES</span>
        <div class="switch" id="langSwitch" role="button" tabindex="0" aria-label="Toggle language">
          <div class="knob"></div>
        </div>
        <span>EN</span>
      </div>
    </div>

    <section class="card" aria-label="Partner form">
      <div class="pad">
        <div class="row">
          <div>
            <label><span data-i18n="business_name_label">Business name</span><span class="reqMark">*</span></label>
            <input id="business_name" autocomplete="organization" />
          </div>
          <div>
            <label><span data-i18n="business_type_label">Category</span><span class="reqMark">*</span></label>
            <select id="business_type"></select>
            <div class="help" data-i18n="business_type_help">Choose one.</div>
          </div>
        </div>

        <div class="row">
          <div>
            <label><span data-i18n="email_label">Business email</span><span class="reqMark">*</span></label>
            <input id="email" type="email" autocomplete="email" />
          </div>
          <div>
            <label data-i18n="phone_label">Phone (optional)</label>
            <input id="phone" autocomplete="tel" />
          </div>
        </div>

        <div class="row">
          <div>
            <label><span data-i18n="website_label">Website URL</span><span class="reqMark">*</span></label>
            <input id="website_url" />
          </div>
          <div>
            <label data-i18n="whatsapp_label">WhatsApp URL (optional)</label>
            <input id="whatsapp_url" />
          </div>
        </div>

        <div class="row">
          <div>
            <label data-i18n="images_label">Image URLs (optional)</label>
            <input id="image_1_url" placeholder="Image URL 1" style="margin-bottom:10px" />
            <input id="image_2_url" placeholder="Image URL 2" style="margin-bottom:10px" />
            <input id="image_3_url" placeholder="Image URL 3" />
            <div class="help" data-i18n="images_help">
              If you do not have image URLs, use the upload link on the right, or email photos to the team.
            </div>
          </div>

          <div>
            <label><span data-i18n="regions_label">Regions</span><span class="reqMark">*</span></label>
            <div class="pillBox" id="regionsBox"></div>
            <div class="help" data-i18n="regions_help">Select all that apply.</div>

            <div style="margin-top:12px">
              <label><span data-i18n="locations_label">Locations</span><span class="reqMark">*</span></label>
              <div class="pillBox" id="locationsBox"></div>
              <div class="help" data-i18n="locations_help">Locations update based on selected regions.</div>
            </div>
          </div>
        </div>

        <div class="row one">
          <div>
            <label><span data-i18n="experiences_label">Experiences</span><span class="reqMark">*</span></label>
            <div class="pillBox" id="experiencesBox"></div>
            <div class="help" data-i18n="experiences_help">Select all that apply.</div>
          </div>
        </div>

        <div class="row">
          <div>
            <label data-i18n="desc_es_label">Short description (Spanish)</label>
            <textarea id="short_description_es"></textarea>
          </div>
          <div>
            <label data-i18n="desc_en_label">Short description (English)</label>
            <textarea id="short_description_en"></textarea>
          </div>
        </div>

        <div class="callout" aria-label="Photo upload callout">
          <h3 data-i18n="photo_title">Photos (optional)</h3>
          <p data-i18n="photo_body">
            If you have a Google account, you can upload photos using our upload form. Google requires sign-in for file uploads. If you do not have a Google account, paste image URLs above or email photos to the team.
          </p>
          <p style="margin-top:8px">
            <a id="photoUploadLink" href="#" target="_blank" rel="noopener">Open photo upload form</a>
          </p>
        </div>

        <div class="row one" style="margin-top:14px">
          <div class="consentRow">
            <label><span data-i18n="consent_publish_label">I confirm you may publish these details on Experience Ecuador.</span><span class="reqMark">*</span></label>
            <input id="consent_publish" type="checkbox" />
          </div>
          <div class="consentRow" style="margin-top:10px">
            <label><span data-i18n="consent_contact_label">I agree Experience Ecuador may contact me about my submission.</span><span class="reqMark">*</span></label>
            <input id="consent_contact" type="checkbox" />
          </div>
        </div>

        <div class="okBox" id="okBox"></div>
        <div class="errBox" id="errBox"></div>
      </div>

      <div class="actions">
        <div class="note" data-i18n="note">Submissions are reviewed before publishing. No public prices are displayed.</div>
        <div class="btnRow">
          <button class="btn" id="btnReset" type="button" data-i18n="reset">Reset</button>
          <button class="btn primary" id="btnSubmit" type="button">
            <span class="spinner" aria-hidden="true"></span>
            <span class="btnText" data-i18n="submit">Submit</span>
          </button>
        </div>
      </div>
    </section>

    <iframe id="eeSubmitFrame" name="eeSubmitFrame" title="Submission frame" style="width:0;height:0;border:0;display:none"></iframe>
  </main>

  <div id="siteFooter"></div>

  <script src="/assets/js/site.js"></script>

  <script>
    (function(){
      async function inject(id, url){
        var el = document.getElementById(id);
        if(!el) return;
        var res = await fetch(url, { cache: "no-store" });
        el.innerHTML = await res.text();
      }
      inject("siteHeader", "/assets/includes/header.html");
      inject("siteFooter", "/assets/includes/footer.html");
    })();
  </script>

  <script>
    (function(){
      "use strict";

      // 1) API endpoint (Apps Script Web App URL)
      // IMPORTANT: This must point to your EE_Onboarding API deployment (doPost returns an HTML postMessage payload).
      var API_URL = "https://script.google.com/macros/s/AKfycbyRKvcA3pKXEwA6rJS6TIqiG9AGzhNFaAX_MTKKZ12nf_XyrpCc-O5S5nOGfo2C1QEcTw/exec";

      // 2) Optional Google Form upload link (file uploads require sign-in)
      var PHOTO_UPLOAD_FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLSf4bTVL36AFYwK1WUyPZbYvkJ891VYnYQrh1VaibIsMCKwEbA/viewform";

      // 3) Data sources (your site JSON). If these 404, the page falls back to a minimal list.
      var REGIONS_JSON_URL = "/assets/data/regions.json";
      var EXPERIENCES_JSON_URL = "/assets/data/experiences.json";

      var state = {
        lang: "es",
        regions: [],
        experiences: [],
        businessTypes: [
          { id: "lodging", en: "Lodging", es: "Alojamiento" },
          { id: "restaurants", en: "Restaurants", es: "Restaurantes" },
          { id: "services", en: "Services", es: "Servicios" },
          { id: "activities", en: "Activities", es: "Actividades" }
        ]
      };

      var STR = {
        en: {
          title: "Partner Application",
          subtitle: "Submit your details to be considered for Recommended by Experience Ecuador. You can select multiple regions, locations, and experiences.",
          business_name_label: "Business name",
          business_type_label: "Category",
          business_type_help: "Choose one.",
          email_label: "Business email",
          phone_label: "Phone (optional)",
          website_label: "Website URL",
          whatsapp_label: "WhatsApp URL (optional)",
          images_label: "Image URLs (optional)",
          images_help: "If you do not have image URLs, use the upload link on the right, or email photos to the team.",
          regions_label: "Regions",
          regions_help: "Select all that apply.",
          locations_label: "Locations",
          locations_help: "Locations update based on selected regions.",
          experiences_label: "Experiences",
          experiences_help: "Select all that apply.",
          desc_es_label: "Short description (Spanish)",
          desc_en_label: "Short description (English)",
          photo_title: "Photos (optional)",
          photo_body: "If you have a Google account, you can upload photos using our upload form. Google requires sign-in for file uploads. If you do not have a Google account, paste image URLs above or email photos to the team.",
          consent_publish_label: "I confirm you may publish these details on Experience Ecuador.",
          consent_contact_label: "I agree Experience Ecuador may contact me about my submission.",
          note: "Submissions are reviewed before publishing. No public prices are displayed.",
          reset: "Reset",
          submit: "Submit",
          select: "Select",
          required_missing: "Please complete all required fields: business name, email, category, website, at least 1 region, at least 1 location, at least 1 experience, and both consent checkboxes.",
          sending: "Submitting...",
          success: "Thanks. We received your submission. A confirmation email was sent to your business email."
        },
        es: {
          title: "Registro de Socios",
          subtitle: "Envianos tu informacion para ser considerado en Recomendado por Experience Ecuador. Puedes seleccionar varias regiones, ubicaciones y experiencias.",
          business_name_label: "Nombre del negocio",
          business_type_label: "Categoria",
          business_type_help: "Elige una.",
          email_label: "Correo del negocio",
          phone_label: "Telefono (opcional)",
          website_label: "Sitio web",
          whatsapp_label: "WhatsApp (opcional)",
          images_label: "Enlaces de imagen (opcional)",
          images_help: "Si no tienes enlaces, usa el formulario de carga o envia las fotos por correo.",
          regions_label: "Regiones",
          regions_help: "Selecciona todas las que correspondan.",
          locations_label: "Ubicaciones",
          locations_help: "Las ubicaciones se actualizan segun las regiones seleccionadas.",
          experiences_label: "Experiencias",
          experiences_help: "Selecciona todas las que correspondan.",
          desc_es_label: "Descripcion corta (espanol)",
          desc_en_label: "Descripcion corta (ingles)",
          photo_title: "Fotos (opcional)",
          photo_body: "Si tienes cuenta de Google, puedes subir fotos con nuestro formulario. Google requiere iniciar sesion para subir archivos. Si no tienes cuenta, pega enlaces de imagen arriba o envia las fotos por correo.",
          consent_publish_label: "Confirmo que pueden publicar esta informacion en Experience Ecuador.",
          consent_contact_label: "Acepto que Experience Ecuador me contacte sobre esta solicitud.",
          note: "Revisamos cada solicitud antes de publicar. No mostramos precios publicamente.",
          reset: "Limpiar",
          submit: "Enviar",
          select: "Selecciona",
          required_missing: "Completa los campos obligatorios: nombre, correo, categoria, sitio web, al menos 1 region, al menos 1 ubicacion, al menos 1 experiencia y marcar los 2 consentimientos.",
          sending: "Enviando...",
          success: "Gracias. Recibimos tu solicitud. Se envio un correo de confirmacion al correo del negocio."
        }
      };

      function qs(sel, root){ return (root || document).querySelector(sel); }
      function qsa(sel, root){ return Array.prototype.slice.call((root || document).querySelectorAll(sel)); }
      function $(id){ return document.getElementById(id); }

      function getLangFromUrl(){
        var u = new URL(window.location.href);
        var lang = String(u.searchParams.get("lang") || "").toLowerCase().trim();
        return (lang === "en") ? "en" : "es";
      }

      function esc(s){
        return String(s || "").replace(/[&<>"']/g, function(m){
          return ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]);
        });
      }

      function t(key){
        return (STR[state.lang] && STR[state.lang][key]) ? STR[state.lang][key] : key;
      }

      function applyI18n(){
        document.documentElement.lang = state.lang;
        qsa("[data-i18n]").forEach(function(el){
          var key = el.getAttribute("data-i18n");
          if (!key) return;
          el.textContent = t(key);
        });
        $("langSwitch").classList.toggle("is-en", state.lang === "en");
      }

      function checkboxPillHtml(id, label, group, value, checked){
        var safeId = group + "_" + id;
        return (
          '<label class="pill" for="'+ safeId +'">' +
            '<input id="'+ safeId +'" type="checkbox" data-group="'+ group +'" value="'+ esc(value) +'" ' + (checked ? "checked" : "") + '> ' +
            '<span>'+ esc(label) +'</span>' +
          '</label>'
        );
      }

      function getSelectedValues(group){
        return qsa('input[type="checkbox"][data-group="'+group+'"]:checked').map(function(x){
          return String(x.value || "").trim();
        }).filter(Boolean);
      }

      function renderBusinessTypes(){
        var sel = $("business_type");
        var current = sel.value || "";
        var opts = ['<option value="">'+ esc(t("select")) +'</option>'];
        state.businessTypes.forEach(function(x){
          opts.push('<option value="'+ esc(x.id) +'">'+ esc(state.lang === "es" ? x.es : x.en) +'</option>');
        });
        sel.innerHTML = opts.join("");
        if (current) sel.value = current;
      }

      function renderRegions(preserve){
        var prev = preserve ? getSelectedValues("regions") : [];
        $("regionsBox").innerHTML = state.regions.map(function(r){
          return checkboxPillHtml(r.id, (state.lang === "es" ? r.title_es : r.title_en), "regions", r.id, prev.indexOf(r.id) !== -1);
        }).join("");
      }

      function renderLocations(preserve){
        var selectedRegions = getSelectedValues("regions");
        var prev = preserve ? getSelectedValues("locations") : [];
        var box = $("locationsBox");

        if (!selectedRegions.length){
          box.innerHTML = "";
          return;
        }

        var locs = [];
        state.regions.forEach(function(r){
          if (selectedRegions.indexOf(r.id) === -1) return;
          (r.locations || []).forEach(function(l){
            locs.push({ id: l.id, label_en: l.name_en, label_es: l.name_es });
          });
        });

        // unique by id
        var seen = {};
        var uniq = [];
        locs.forEach(function(l){
          if (!l.id) return;
          if (seen[l.id]) return;
          seen[l.id] = true;
          uniq.push(l);
        });

        uniq.sort(function(a,b){
          var A = String(state.lang === "es" ? a.label_es : a.label_en);
          var B = String(state.lang === "es" ? b.label_es : b.label_en);
          return A.localeCompare(B, state.lang === "es" ? "es" : "en", { sensitivity:"base" });
        });

        box.innerHTML = uniq.map(function(l){
          var label = (state.lang === "es" ? l.label_es : l.label_en);
          return checkboxPillHtml(l.id, label, "locations", l.id, prev.indexOf(l.id) !== -1);
        }).join("");
      }

      function renderExperiences(preserve){
        var prev = preserve ? getSelectedValues("experiences") : [];
        var box = $("experiencesBox");

        var exps = state.experiences.slice(0).map(function(e){
          return {
            id: e.id,
            label: (state.lang === "es" ? e.name_es : e.name_en)
          };
        });

        exps.sort(function(a,b){
          return String(a.label).localeCompare(String(b.label), state.lang === "es" ? "es" : "en", { sensitivity:"base" });
        });

        box.innerHTML = exps.map(function(e){
          return checkboxPillHtml(e.id, e.label, "experiences", e.id, prev.indexOf(e.id) !== -1);
        }).join("");
      }

      function showOk(msg){
        $("errBox").style.display = "none";
        $("okBox").style.display = "block";
        $("okBox").textContent = msg;
      }

      function showErr(msg){
        $("okBox").style.display = "none";
        $("errBox").style.display = "block";
        $("errBox").textContent = msg;
      }

      function resetForm(){
        ["business_name","email","phone","website_url","whatsapp_url","image_1_url","image_2_url","image_3_url","short_description_en","short_description_es"].forEach(function(id){
          $(id).value = "";
        });
        $("business_type").value = "";
        $("consent_publish").checked = false;
        $("consent_contact").checked = false;

        qsa('input[type="checkbox"][data-group]').forEach(function(x){ x.checked = false; });
        $("locationsBox").innerHTML = "";

        $("okBox").style.display = "none";
        $("errBox").style.display = "none";
      }

      function validate(){
        var business_name = String($("business_name").value || "").trim();
        var email = String($("email").value || "").trim();
        var business_type = String($("business_type").value || "").trim();
        var website = String($("website_url").value || "").trim();

        var regions = getSelectedValues("regions");
        var locations = getSelectedValues("locations");
        var experiences = getSelectedValues("experiences");

        var consentPublish = $("consent_publish").checked;
        var consentContact = $("consent_contact").checked;

        if (!business_name || !email || !business_type || !website) return false;
        if (!regions.length || !locations.length || !experiences.length) return false;
        if (!consentPublish || !consentContact) return false;

        return true;
      }

      function setSubmitting(isSubmitting){
        var btn = $("btnSubmit");
        btn.disabled = !!isSubmitting;
        btn.classList.toggle("is-loading", !!isSubmitting);
        qs(".btnText", btn).textContent = isSubmitting ? t("sending") : t("submit");
      }

      function buildPayload(){
        return {
          source: "ee_site_join",
          language: state.lang,

          business_name: String($("business_name").value || "").trim(),
          business_type: String($("business_type").value || "").trim(),

          email: String($("email").value || "").trim(),
          phone: String($("phone").value || "").trim(),
          website_url: String($("website_url").value || "").trim(),
          whatsapp_url: String($("whatsapp_url").value || "").trim(),

          image_1_url: String($("image_1_url").value || "").trim(),
          image_2_url: String($("image_2_url").value || "").trim(),
          image_3_url: String($("image_3_url").value || "").trim(),

          regions: getSelectedValues("regions"),
          locations: getSelectedValues("locations"),
          experiences: getSelectedValues("experiences"),

          short_description_en: String($("short_description_en").value || "").trim(),
          short_description_es: String($("short_description_es").value || "").trim(),

          consent_publish: $("consent_publish").checked ? "yes" : "no",
          consent_contact: $("consent_contact").checked ? "yes" : "no"
        };
      }

      function submitViaIframe(payload){
        // Build a temporary form that posts to Apps Script (cross-origin) and returns an HTML postMessage.
        var f = document.createElement("form");
        f.method = "POST";
        f.action = API_URL;
        f.target = "eeSubmitFrame";

        function add(name, value){
          var i = document.createElement("input");
          i.type = "hidden";
          i.name = name;
          i.value = value;
          f.appendChild(i);
        }

        // Flatten arrays to comma strings for form-encoded submission
        Object.keys(payload).forEach(function(k){
          var v = payload[k];
          if (Array.isArray(v)) add(k, v.join(", "));
          else add(k, String(v == null ? "" : v));
        });

        document.body.appendChild(f);
        f.submit();
        setTimeout(function(){ try{ f.remove(); }catch(_){ } }, 0);
      }

      function boot(){
        state.lang = getLangFromUrl();
        applyI18n();

        // Photo upload link
        var a = $("photoUploadLink");
        a.href = PHOTO_UPLOAD_FORM_URL;

        // Load regions + experiences from site JSON
        Promise.all([
          fetch(REGIONS_JSON_URL, { cache: "no-store" }).then(function(r){ return r.ok ? r.json() : null; }).catch(function(){ return null; }),
          fetch(EXPERIENCES_JSON_URL, { cache: "no-store" }).then(function(r){ return r.ok ? r.json() : null; }).catch(function(){ return null; })
        ]).then(function(res){
          var regionsData = res[0];
          var expsData = res[1];

          // Regions JSON format:
          // { "regions": [ { "id":"andes", "title":"Andes", "locations":[{"name":"Quito","slug":"quito"}...] } ] }
          if (regionsData && regionsData.regions && Array.isArray(regionsData.regions)){
            state.regions = regionsData.regions.map(function(r){
              var rid = String(r.id || r.slug || "").trim();
              var title = String(r.title || r.name || rid).trim();
              var locs = Array.isArray(r.locations) ? r.locations : [];
              return {
                id: rid,
                title_en: title,
                title_es: title, // your regions titles are already fine in ES (Andes, Costa, Amazonia, Galapagos)
                locations: locs.map(function(l){
                  var lid = String(l.slug || l.id || l.name || "").trim();
                  var nm = String(l.name || l.title || lid).trim();
                  return { id: lid, name_en: nm, name_es: nm };
                })
              };
            }).filter(function(r){ return !!r.id; });
          } else {
            // Minimal fallback (should not happen if /assets/data/regions.json exists)
            state.regions = [
              { id:"andes", title_en:"Andes", title_es:"Andes", locations:[{id:"quito",name_en:"Quito",name_es:"Quito"}] },
              { id:"coast", title_en:"Coast", title_es:"Costa", locations:[{id:"guayaquil",name_en:"Guayaquil",name_es:"Guayaquil"}] }
            ];
          }

          // Experiences JSON format:
          // { "experiences": [ { "id":"adventure", "name":"Adventure" } ] }
          if (expsData && expsData.experiences && Array.isArray(expsData.experiences)){
            state.experiences = expsData.experiences.map(function(e){
              var id = String(e.id || "").trim();
              var name = String(e.name || id).trim();
              return { id: id, name_en: name, name_es: name };
            }).filter(function(e){ return !!e.id; });
          } else {
            state.experiences = [
              { id:"adventure", name_en:"Adventure", name_es:"Aventura" },
              { id:"nature", name_en:"Nature", name_es:"Naturaleza" }
            ];
          }

          renderBusinessTypes();
          renderRegions(false);
          renderLocations(false);
          renderExperiences(false);

          // UI wiring
          $("btnReset").addEventListener("click", resetForm);

          $("btnSubmit").addEventListener("click", function(){
            $("okBox").style.display = "none";
            $("errBox").style.display = "none";

            if (!validate()){
              showErr(t("required_missing"));
              return;
            }

            setSubmitting(true);
            submitViaIframe(buildPayload());
          });

          // Region change updates locations
          document.addEventListener("change", function(e){
            var t = e.target;
            if (t && t.matches && t.matches('input[type="checkbox"][data-group="regions"]')){
              renderLocations(true);
            }
          });

          // Language toggle (preserve selected values)
          var sw = $("langSwitch");
          var toggleLang = function(){
            state.lang = (state.lang === "es") ? "en" : "es";
            applyI18n();
            renderBusinessTypes();
            renderRegions(true);
            renderLocations(true);
            renderExperiences(true);
          };
          sw.addEventListener("click", toggleLang);
          sw.addEventListener("keydown", function(e){
            if (e.key === "Enter" || e.key === " "){
              e.preventDefault();
              toggleLang();
            }
          });

          // Listen for Apps Script postMessage
          window.addEventListener("message", function(ev){
            var d = ev && ev.data ? ev.data : null;
            if (!d || d.__ee_onboarding__ !== true) return;

            setSubmitting(false);

            if (d.ok){
              showOk(t("success"));
              resetForm();
            } else {
              showErr(d.error || "Submission failed.");
            }
          });
        });
      }

      boot();
    })();
  </script>
</body>
</html>
