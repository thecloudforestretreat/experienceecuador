<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Registro de Socios | Experience Ecuador</title>
  <meta name="description" content="Envíanos tu información para ser considerado en Recomendado por Experience Ecuador." />
  <meta name="robots" content="index,follow" />
  <link rel="canonical" href="https://experienceecuador.com/es/aliados/unirse/" />

  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="Experience Ecuador" />
  <meta property="og:title" content="Registro de Socios | Experience Ecuador" />
  <meta property="og:description" content="Envíanos tu información para ser considerado en Recomendado por Experience Ecuador." />
  <meta property="og:url" content="https://experienceecuador.com/es/aliados/unirse/" />
  <meta property="og:image" content="https://experienceecuador.com/EE-OG-Image-1.jpg" />

  <link rel="icon" href="/favicon.ico" sizes="any" />
  <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
  <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
  <link rel="manifest" href="/site.webmanifest" />
  <meta name="theme-color" content="#034EA2" />

  <link rel="stylesheet" href="/assets/css/header.css" />
  <link rel="stylesheet" href="/assets/css/footer.css" />

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;800&family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />

  <style>
    :root{
      --brand:#034EA2; --ink:#0f2f62; --text:#1f2a3a; --muted:#6b7280; --bg:#f6f8fb;
      --card:#ffffff; --line: rgba(0,0,0,0.08); --shadow: 0 18px 55px rgba(3,78,162,0.12);
      --shadowSoft: 0 14px 34px rgba(3,78,162,0.10); --r-xl: 24px; --max: 1040px;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{ margin:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color: var(--text); background: var(--bg); }
    a{ color: inherit; text-decoration:none; }
    .wrap{ max-width: var(--max); margin:0 auto; padding: 22px 18px 72px; }
    .topRow{ display:flex; align-items:flex-start; justify-content:space-between; gap:12px; flex-wrap:wrap; margin:10px 0 16px; }
    h1{ margin:0; font-family: Montserrat, Inter, sans-serif; font-weight:800; letter-spacing:-0.03em; color: var(--brand); font-size: 30px; line-height:1.1; }
    .sub{ margin:8px 0 0; color: var(--muted); line-height:1.6; font-weight:600; max-width: 86ch; font-size: 14px; }

    .toggle{ display:inline-flex; align-items:center; gap:10px; padding:10px 12px; border-radius:999px; border:1px solid rgba(3,78,162,0.18); background: rgba(255,255,255,0.92); color: var(--ink); font-weight:900; font-size:12.5px; user-select:none; box-shadow: var(--shadowSoft); }
    .switch{ width:46px; height:28px; border-radius:999px; background: rgba(3,78,162,0.14); position:relative; cursor:pointer; border:1px solid rgba(3,78,162,0.18); flex:0 0 auto; }
    .knob{ position:absolute; top:3px; left:3px; width:22px; height:22px; border-radius:999px; background:#fff; box-shadow:0 10px 22px rgba(0,0,0,0.10); transition: transform 180ms ease; }
    .switch.is-en .knob{ transform: translateX(18px); }

    .card{ background: var(--card); border: 1px solid var(--line); border-radius: var(--r-xl); box-shadow: var(--shadow); overflow:hidden; }
    .pad{ padding:16px; }
    .row{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top:12px; }
    .row.one{ grid-template-columns: 1fr; }
    label{ display:block; font-weight:900; font-size:12.5px; color: var(--ink); margin: 0 0 6px; }
    .req{ color:#b91c1c; margin-right:6px; }
    input, textarea, select{ width:100%; border:1px solid rgba(3,78,162,0.18); border-radius:14px; padding:11px 12px; font-size:14px; outline:none; background: rgba(255,255,255,0.98); }
    textarea{ min-height: 96px; resize: vertical; }
    .help{ font-size:12px; color: var(--muted); font-weight:650; margin-top:6px; line-height:1.5; }

    .pillBox{ border:1px solid rgba(3,78,162,0.18); border-radius:14px; padding:10px; background: rgba(3,78,162,0.03); display:flex; flex-wrap:wrap; gap:10px; }
    .pill{ display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:999px; border:1px solid rgba(3,78,162,0.18); background: rgba(255,255,255,0.92); font-weight:900; font-size:12.5px; color: var(--ink); cursor:pointer; user-select:none; white-space:nowrap; }
    .pill input{ width:auto; margin:0; }

    .uploadBand{ border-radius:16px; border:1px solid rgba(3,78,162,0.18); background: rgba(3,78,162,0.04); padding:12px; margin-top:10px; }
    .uploadBand strong{ color: var(--ink); }
    .uploadRow{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:8px; }
    .btnLink{ display:inline-flex; align-items:center; justify-content:center; padding:10px 12px; border-radius:14px; font-weight:900; border:1px solid rgba(3,78,162,0.18); background: rgba(255,255,255,0.96); color: var(--ink); box-shadow: var(--shadowSoft); }

    .consentRow{ display:flex; align-items:flex-start; justify-content:space-between; gap:12px; padding:12px; border-radius:14px; border:1px solid rgba(3,78,162,0.18); background: rgba(255,255,255,0.92); }
    .consentRow label{ margin:0; font-size:12.8px; line-height:1.5; font-weight:900; color: var(--ink); }
    .consentRow input{ width:auto; margin-top:2px; }

    .turnstileWrap{ margin-top:12px; padding:12px; border-radius:14px; border:1px solid rgba(3,78,162,0.18); background: rgba(255,255,255,0.92); }
    .turnstileHelp{ margin-top:8px; font-size:12px; color: var(--muted); font-weight:750; line-height:1.5; }

    .okBox, .errBox{ margin:14px 16px 0; padding:12px 14px; border-radius:14px; border:1px solid rgba(0,0,0,0.08); background: rgba(255,255,255,0.92); font-weight:800; display:none; line-height:1.55; font-size:13px; }
    .okBox{ border-color: rgba(16,185,129,0.35); }
    .errBox{ border-color: rgba(239,68,68,0.35); }

    .actions{ display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; padding:16px; border-top:1px solid var(--line); background: rgba(3,78,162,0.02); }
    .note{ font-weight:800; color: var(--ink); font-size:12.5px; line-height:1.45; max-width:66ch; }
    .btnRow{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .btn{ display:inline-flex; align-items:center; justify-content:center; padding:12px 14px; border-radius:14px; font-weight:900; border:1px solid rgba(3,78,162,0.18); background: rgba(255,255,255,0.96); color: var(--ink); cursor:pointer; box-shadow: var(--shadowSoft); }
    .btn.primary{ background: rgba(3,78,162,0.95); color:#fff; border-color: rgba(3,78,162,0.28); box-shadow: 0 18px 40px rgba(3,78,162,0.18); }
    .btn:disabled{ opacity:.65; cursor: default; }
    .spinner{ display:none; margin-left:10px; font-weight:800; color: rgba(255,255,255,0.90); }
    .btn.primary.is-loading .spinner{ display:inline; }
    iframe#eeSubmitFrame{ width:0; height:0; border:0; position:absolute; left:-9999px; top:-9999px; }

    @media (max-width: 900px){
      .wrap{ padding: 18px 14px 64px; }
      .row{ grid-template-columns: 1fr; }
      .note{ max-width:none; }
    }
  </style>
</head>
<body>
  <div id="siteHeader"></div>

  <main class="wrap" aria-label="Registro de socios">
    <div class="topRow">
      <div>
        <h1 data-i18n="title">Registro de Socios</h1>
        <p class="sub" data-i18n="subtitle">Envíanos tu información para ser considerado en Recomendado por Experience Ecuador.</p>
      </div>

      <div class="toggle" aria-label="Cambiar idioma">
        <span>ES</span>
        <div class="switch" id="langSwitch" role="button" tabindex="0" aria-label="Cambiar idioma">
          <div class="knob"></div>
        </div>
        <span>EN</span>
      </div>
    </div>

    <section class="card" aria-label="Formulario de aliados">
      <form id="eeForm" class="pad" method="POST" action="" target="eeSubmitFrame" autocomplete="on">
        <input type="hidden" name="language" id="language" value="es" />
        <input type="hidden" name="source_page" id="source_page" value="https://experienceecuador.com/es/aliados/unirse/" />
        <input type="hidden" name="drive_upload_link" id="drive_upload_link" value="https://docs.google.com/forms/d/e/1FAIpQLSf4bTVL36AFYwK1WUyPZbYvkJ891VYnYQrh1VaibIsMCKwEbA/viewform?usp=sharing" />
        <input type="hidden" name="turnstile_token" id="turnstile_token" value="" />

        <div class="row">
          <div>
            <label><span class="req">*</span><span data-i18n="business_name_label">Nombre del negocio</span></label>
            <input name="business_name" id="business_name" placeholder="Nombre del negocio" required />
          </div>
          <div>
            <label><span class="req">*</span><span data-i18n="business_type_label">Categoría</span></label>
            <select name="business_type" id="business_type" required></select>
            <div class="help" data-i18n="business_type_help">Elige una.</div>
          </div>
        </div>

        <div class="row">
          <div>
            <label><span class="req">*</span><span data-i18n="contact_first_name_label">Nombre</span></label>
            <input name="contact_first_name" id="contact_first_name" placeholder="Nombre" required />
          </div>
          <div>
            <label><span class="req">*</span><span data-i18n="contact_last_name_label">Apellido</span></label>
            <input name="contact_last_name" id="contact_last_name" placeholder="Apellido" required />
          </div>
        </div>

        <div class="row">
          <div>
            <label><span class="req">*</span><span data-i18n="contact_email_label">Correo</span></label>
            <input name="contact_email" id="contact_email" type="email" placeholder="hola@ejemplo.com" required />
          </div>
          <div>
            <label><span class="req">*</span><span data-i18n="contact_phone_label">Teléfono</span></label>
            <input name="contact_phone" id="contact_phone" placeholder="+593 ..." required />
          </div>
        </div>

        <div class="row">
          <div>
            <label><span class="req">*</span><span data-i18n="website_label">Sitio web</span></label>
            <input name="website_url" id="website_url" placeholder="https://ejemplo.com" required />
          </div>
          <div>
            <label><span data-i18n="whatsapp_label">WhatsApp (opcional)</span></label>
            <input name="whatsapp_url" id="whatsapp_url" placeholder="https://wa.me/..." />
          </div>
        </div>

        <div class="row">
          <div>
            <label><span data-i18n="photos_label">Fotos</span></label>

            <div class="uploadBand">
              <div><strong data-i18n="photos_upload_title">Opción A: Subir imágenes</strong></div>
              <div class="help" data-i18n="photos_upload_help">Si tienes cuenta de Google, puedes subir imágenes con nuestro formulario. Google requiere iniciar sesión para subir archivos.</div>
              <div class="uploadRow">
                <a class="btnLink" id="uploadFormLink" href="https://docs.google.com/forms/d/e/1FAIpQLSf4bTVL36AFYwK1WUyPZbYvkJ891VYnYQrh1VaibIsMCKwEbA/viewform?usp=sharing" target="_blank" rel="noopener" data-i18n="open_upload_form">Abrir formulario de carga</a>
              </div>
            </div>

            <div style="margin-top:10px">
              <div class="help" data-i18n="photos_urls_help">Opción B: Si ya tienes enlaces directos a imágenes, pégalos aquí (opcional).</div>
              <input name="image_1_url" id="image_1_url" placeholder="Image URL 1" style="margin-top:8px" />
              <input name="image_2_url" id="image_2_url" placeholder="Image URL 2" style="margin-top:10px" />
              <input name="image_3_url" id="image_3_url" placeholder="Image URL 3" style="margin-top:10px" />
            </div>

            <div class="help" data-i18n="photos_fallback">Opción C: Si ninguna opción sirve, puedes enviarlas por correo a info@experienceecuador.com.</div>
          </div>

          <div>
            <label><span class="req">*</span><span data-i18n="regions_label">Regiones</span></label>
            <div class="pillBox" id="regionsBox"></div>
            <div class="help" data-i18n="regions_help">Selecciona todas las que correspondan.</div>

            <div style="margin-top:12px">
              <label><span class="req">*</span><span data-i18n="locations_label">Ubicaciones</span></label>
              <div class="pillBox" id="locationsBox"></div>
              <div class="help" data-i18n="locations_help">Las ubicaciones se actualizan según las regiones seleccionadas.</div>
            </div>
          </div>
        </div>

        <div class="row one">
          <div>
            <label><span class="req">*</span><span data-i18n="experiences_label">Experiencias</span></label>
            <div class="pillBox" id="experiencesBox"></div>
            <div class="help" data-i18n="experiences_help">Selecciona todas las que correspondan.</div>
          </div>
        </div>

        <div class="row">
          <div>
            <label><span data-i18n="desc_es_label">Descripción corta (español)</span></label>
            <textarea name="short_description_es" id="short_description_es" placeholder="Describe tu negocio en 2 a 5 frases."></textarea>
          </div>
          <div>
            <label><span data-i18n="desc_en_label">Descripción corta (inglés)</span></label>
            <textarea name="short_description_en" id="short_description_en" placeholder="Optional"></textarea>
          </div>
        </div>

        <div class="row one" style="margin-top:14px">
          <div class="consentRow">
            <label><span class="req">*</span><span data-i18n="consent_publish_label">Confirmo que pueden publicar esta información en Experience Ecuador.</span></label>
            <input name="consent_publish" id="consent_publish" type="checkbox" value="yes" required />
          </div>
          <div class="consentRow" style="margin-top:10px">
            <label><span class="req">*</span><span data-i18n="consent_contact_label">Acepto que Experience Ecuador me contacte sobre esta solicitud.</span></label>
            <input name="consent_contact" id="consent_contact" type="checkbox" value="yes" required />
          </div>
        </div>

        <div class="turnstileWrap" id="turnstileWrap" style="display:none">
          <div id="turnstileWidget"></div>
          <div class="turnstileHelp" data-i18n="turnstile_help">Completa la verificación de seguridad para enviar.</div>
        </div>
      </form>

      <div class="actions">
        <div class="note" data-i18n="note">Revisamos cada solicitud antes de publicar. No mostramos precios públicamente.</div>
        <div class="btnRow">
          <button class="btn" id="btnReset" type="button" data-i18n="reset">Limpiar</button>
          <button class="btn primary" id="btnSubmit" type="button" data-i18n="submit">Enviar<span class="spinner" id="spinner">Enviando...</span></button>
        </div>
      </div>

      <div class="okBox" id="okBox"></div>
      <div class="errBox" id="errBox"></div>
    </section>

    <iframe id="eeSubmitFrame" name="eeSubmitFrame" title="Submission frame"></iframe>
  </main>

  <div id="siteFooter"></div>

  <script src="/assets/js/site.js"></script>
  <script>
    (function(){
      async function inject(id, url){
        var el = document.getElementById(id);
        if(!el) return;
        try{
          var res = await fetch(url, { cache: "no-store" });
          el.innerHTML = await res.text();
        }catch(e){}
      }
      inject("siteHeader", "/assets/includes/header.html");
      inject("siteFooter", "/assets/includes/footer.html");
    })();
  </script>

  <script>
    (function(){
      var REGIONS = [];
      var EXPERIENCES = [];
      var BUSINESS_TYPES = [
        { id: "lodging", en: "Lodging", es: "Alojamiento" },
        { id: "restaurants", en: "Restaurants", es: "Restaurantes" },
        { id: "services", en: "Services", es: "Servicios" },
        { id: "activities", en: "Activities", es: "Actividades" }
      ];

      var gasOnboardingUrl = "";
      var turnstileSiteKey = "";
      var turnstileWidgetId = null;
      var turnstileToken = "";

      function qs(sel, root){ return (root||document).querySelector(sel); }
      function qsa(sel, root){ return Array.prototype.slice.call((root||document).querySelectorAll(sel)); }
      function esc(s){ return String(s||"").replace(/[&<>"']/g, function(m){ return ({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"})[m]; }); }

      var lang = "es";
      var STR = {
        es: {
          title: "Registro de Socios",
          subtitle: "Envíanos tu información para ser considerado en Recomendado por Experience Ecuador.",
          business_name_label: "Nombre del negocio",
          business_type_label: "Categoría",
          business_type_help: "Elige una.",
          contact_first_name_label: "Nombre",
          contact_last_name_label: "Apellido",
          contact_email_label: "Correo",
          contact_phone_label: "Teléfono",
          website_label: "Sitio web",
          whatsapp_label: "WhatsApp (opcional)",
          photos_label: "Fotos",
          photos_upload_title: "Opción A: Subir imágenes",
          photos_upload_help: "Si tienes cuenta de Google, puedes subir imágenes con nuestro formulario. Google requiere iniciar sesión para subir archivos.",
          open_upload_form: "Abrir formulario de carga",
          photos_urls_help: "Opción B: Si ya tienes enlaces directos a imágenes, pégalos aquí (opcional).",
          photos_fallback: "Opción C: Si ninguna opción sirve, puedes enviarlas por correo a info@experienceecuador.com.",
          regions_label: "Regiones",
          regions_help: "Selecciona todas las que correspondan.",
          locations_label: "Ubicaciones",
          locations_help: "Las ubicaciones se actualizan según las regiones seleccionadas.",
          experiences_label: "Experiencias",
          experiences_help: "Selecciona todas las que correspondan.",
          desc_es_label: "Descripción corta (español)",
          desc_en_label: "Descripción corta (inglés)",
          consent_publish_label: "Confirmo que pueden publicar esta información en Experience Ecuador.",
          consent_contact_label: "Acepto que Experience Ecuador me contacte sobre esta solicitud.",
          turnstile_help: "Completa la verificación de seguridad para enviar.",
          note: "Revisamos cada solicitud antes de publicar. No mostramos precios públicamente.",
          reset: "Limpiar",
          submit: "Enviar",
          submitting: "Enviando...",
          select: "Selecciona",
          required_missing: "Completa los campos obligatorios marcados con *.",
          security_missing: "Completa la verificación de seguridad antes de enviar.",
          success: "Gracias. Recibimos tu solicitud. Te escribiremos si necesitamos algo adicional.",
          confirm_timeout: "No se recibió confirmación. Si recibiste el correo, la solicitud se envió.",
          load_failed: "No pudimos cargar las opciones del formulario. Recarga la página e inténtalo de nuevo."
        },
        en: {
          title: "Partner Application",
          subtitle: "Submit your details to be considered for Recommended by Experience Ecuador.",
          business_name_label: "Business name",
          business_type_label: "Category",
          business_type_help: "Choose one.",
          contact_first_name_label: "Contact first name",
          contact_last_name_label: "Contact last name",
          contact_email_label: "Contact email",
          contact_phone_label: "Contact phone",
          website_label: "Website URL",
          whatsapp_label: "WhatsApp URL (optional)",
          photos_label: "Photos",
          photos_upload_title: "Option A: Upload images",
          photos_upload_help: "If you have a Google account, you can upload images using our upload form. Google requires sign-in for file uploads.",
          open_upload_form: "Open upload form",
          photos_urls_help: "Option B: If you already have direct image URLs, you can paste them here (optional).",
          photos_fallback: "Option C: If neither works, you can email images to info@experienceecuador.com.",
          regions_label: "Regions",
          regions_help: "Select all that apply.",
          locations_label: "Locations",
          locations_help: "Locations update based on selected regions.",
          experiences_label: "Experiences",
          experiences_help: "Select all that apply.",
          desc_es_label: "Short description (Spanish)",
          desc_en_label: "Short description (English)",
          consent_publish_label: "I confirm you may publish these details on Experience Ecuador.",
          consent_contact_label: "I agree Experience Ecuador may contact me about my submission.",
          turnstile_help: "Complete the security check to submit.",
          note: "Submissions are reviewed before publishing. No public prices are displayed.",
          reset: "Reset",
          submit: "Submit",
          submitting: "Submitting...",
          select: "Select",
          required_missing: "Please complete all required fields marked with *.",
          security_missing: "Please complete the security check before submitting.",
          success: "Thanks. We received your submission. We will follow up by email if we need anything else.",
          confirm_timeout: "No confirmation returned. If you received the email, the submission worked.",
          load_failed: "We could not load the form options. Please refresh and try again."
        }
      };

      function t(k){ return (STR[lang] && STR[lang][k]) ? STR[lang][k] : k; }

      function showOk(msg){
        var ok = qs("#okBox"), er = qs("#errBox");
        if(er) er.style.display = "none";
        if(ok){ ok.style.display = "block"; ok.textContent = msg; }
      }

      function showErr(msg){
        var ok = qs("#okBox"), er = qs("#errBox");
        if(ok) ok.style.display = "none";
        if(er){ er.style.display = "block"; er.textContent = msg; }
      }

      function clearMessages(){
        var ok = qs("#okBox"), er = qs("#errBox");
        if(ok) ok.style.display = "none";
        if(er) er.style.display = "none";
      }

      function setPlaceholders(){
        var isEs = (lang === "es");
        var ph = {
          business_name: isEs ? "Nombre del negocio" : "Business name",
          contact_first_name: isEs ? "Nombre" : "First name",
          contact_last_name: isEs ? "Apellido" : "Last name",
          contact_email: isEs ? "hola@ejemplo.com" : "hello@example.com",
          website_url: isEs ? "https://ejemplo.com" : "https://example.com",
          short_description_es: isEs ? "Opcional" : "Optional",
          short_description_en: "Optional"
        };
        Object.keys(ph).forEach(function(id){
          var el = qs("#" + id);
          if(el && typeof el.placeholder === "string"){
            el.placeholder = ph[id];
          }
        });
      }

      function setText(){
        document.documentElement.lang = lang;

        var langField = qs("#language");
        if(langField) langField.value = lang;

        var sw = qs("#langSwitch");
        if(sw) sw.classList.toggle("is-en", lang === "en");

        var sp = qs("#spinner");
        if(sp) sp.textContent = t("submitting");

        qsa("[data-i18n]").forEach(function(el){
          var key = el.getAttribute("data-i18n");
          if(!key) return;
          el.textContent = t(key);
        });

        setPlaceholders();
      }

      function renderBusinessTypes(){
        var sel = qs("#business_type");
        if(!sel) return;
        var current = sel.value || "";
        var opts = ['<option value="">' + esc(t("select")) + '</option>'];
        BUSINESS_TYPES.forEach(function(bt){
          var label = (lang === "es") ? bt.es : bt.en;
          opts.push('<option value="' + esc(bt.id) + '">' + esc(label) + '</option>');
        });
        sel.innerHTML = opts.join("");
        if(current) sel.value = current;
      }

      function pill(id, label, group, value, checked){
        var safeId = group + "_" + id;
        return '<label class="pill" for="' + safeId + '"><input id="' + safeId + '" type="checkbox" name="' + group + '" value="' + esc(value) + '"' + (checked ? " checked" : "") + '><span>' + esc(label) + '</span></label>';
      }

      function getChecked(group){
        return qsa('input[type="checkbox"][name="' + group + '"]:checked').map(function(x){ return (x.value||"").trim(); }).filter(Boolean);
      }

      function renderRegions(preserve){
        var prev = preserve ? getChecked("regions") : [];
        var box = qs("#regionsBox");
        if(!box) return;

        box.innerHTML = REGIONS.map(function(r){
          var nm = (lang === "es") ? (r.name_es || r.name_en || r.name || r.id) : (r.name_en || r.name || r.id);
          return pill(r.id, nm, "regions", r.id, prev.indexOf(r.id) !== -1);
        }).join("");
      }

      function renderLocations(preserve){
        var selected = getChecked("regions");
        var prev = preserve ? getChecked("locations") : [];
        var box = qs("#locationsBox");
        if(!box) return;

        if(!selected.length){
          box.innerHTML = "";
          return;
        }

        var locs = [];
        REGIONS.forEach(function(r){
          if(selected.indexOf(r.id) === -1) return;
          (r.locations || []).forEach(function(l){
            var nm = (lang === "es") ? (l.name_es || l.name_en || l.name || l.id) : (l.name_en || l.name || l.id);
            locs.push({ id: l.id, label: nm });
          });
        });

        var seen = {};
        var uniq = [];
        locs.forEach(function(l){ if(l.id && !seen[l.id]){ seen[l.id]=true; uniq.push(l); } });

        uniq.sort(function(a,b){
          return String(a.label).localeCompare(String(b.label), (lang==="es" ? "es" : "en"), { sensitivity:"base" });
        });

        box.innerHTML = uniq.map(function(l){
          return pill(l.id, l.label, "locations", l.id, prev.indexOf(l.id) !== -1);
        }).join("");
      }

      function renderExperiences(preserve){
        var prev = preserve ? getChecked("experiences") : [];
        var box = qs("#experiencesBox");
        if(!box) return;

        var exps = EXPERIENCES.map(function(e){
          var label = (lang === "es") ? (e.name_es || e.name_en || e.name || e.id) : (e.name_en || e.name || e.id);
          return { id: e.id, label: label };
        });

        exps.sort(function(a,b){
          return String(a.label).localeCompare(String(b.label), (lang==="es" ? "es" : "en"), { sensitivity:"base" });
        });

        box.innerHTML = exps.map(function(e){
          return pill(e.id, e.label, "experiences", e.id, prev.indexOf(e.id) !== -1);
        }).join("");
      }

      function validate(){
        var form = qs("#eeForm");
        if(!form) return false;
        if(!form.checkValidity()) return false;
        if(!getChecked("regions").length) return false;
        if(!getChecked("locations").length) return false;
        if(!getChecked("experiences").length) return false;
        return true;
      }

      function titleCaseWords(s){
        var cleaned = String(s||"").replace(/\s+/g," ").trim();
        if(!cleaned) return "";
        return cleaned.split(" ").map(function(w){
          if(!w) return "";
          return w.charAt(0).toUpperCase() + w.slice(1);
        }).join(" ");
      }

      function bindTitleCase(){
        var bn = qs("#business_name");
        var fn = qs("#contact_first_name");
        var ln = qs("#contact_last_name");
        [bn, fn, ln].forEach(function(el){
          if(!el) return;
          el.addEventListener("blur", function(){
            el.value = titleCaseWords(el.value);
          });
        });
      }

      function setLang(next){
        lang = (next === "en") ? "en" : "es";
        setText();
        renderBusinessTypes();
        renderRegions(true);
        renderLocations(true);
        renderExperiences(true);
        refreshTurnstileText_();
      }

      function setSubmitting(isSubmitting){
        var btn = qs("#btnSubmit");
        if(!btn) return;
        btn.disabled = !!isSubmitting;
        btn.classList.toggle("is-loading", !!isSubmitting);
      }

      function ensureTurnstileScript_(){
        return new Promise(function(resolve){
          if(window.turnstile && typeof window.turnstile.render === "function"){
            resolve(true);
            return;
          }
          var existing = document.getElementById("cfTurnstileScript");
          if(existing){
            existing.addEventListener("load", function(){ resolve(true); });
            existing.addEventListener("error", function(){ resolve(false); });
            return;
          }
          var s = document.createElement("script");
          s.id = "cfTurnstileScript";
          s.src = "https://challenges.cloudflare.com/turnstile/v0/api.js?render=explicit";
          s.async = true;
          s.defer = true;
          s.onload = function(){ resolve(true); };
          s.onerror = function(){ resolve(false); };
          document.head.appendChild(s);
        });
      }

      function refreshTurnstileText_(){
        var help = qs("[data-i18n='turnstile_help']");
        if(help) help.textContent = t("turnstile_help");
      }

      async function mountTurnstile_(){
        var wrap = qs("#turnstileWrap");
        var tokenField = qs("#turnstile_token");
        if(!wrap || !tokenField) return;

        if(!turnstileSiteKey){
          wrap.style.display = "none";
          return;
        }

        wrap.style.display = "block";

        var ok = await ensureTurnstileScript_();
        if(!ok || !window.turnstile){
          wrap.style.display = "none";
          return;
        }

        if(turnstileWidgetId !== null){
          try{ window.turnstile.reset(turnstileWidgetId); }catch(e){}
          return;
        }

        try{
          turnstileWidgetId = window.turnstile.render("#turnstileWidget", {
            sitekey: turnstileSiteKey,
            theme: "light",
            callback: function(token){
              turnstileToken = token || "";
              tokenField.value = turnstileToken;
              var er = qs("#errBox");
              if(er && er.style.display === "block"){
                er.style.display = "none";
              }
            },
            "expired-callback": function(){
              turnstileToken = "";
              tokenField.value = "";
            },
            "error-callback": function(){
              turnstileToken = "";
              tokenField.value = "";
            }
          });
        }catch(e){
          wrap.style.display = "none";
        }
      }

      async function loadConfig_(){
        try{
          var r = await fetch("/api/onboarding-config", { cache: "no-store" });
          var j = await r.json();

          if(j && j.ok){
            gasOnboardingUrl = String(j.gas_onboarding_url || "").trim();
            turnstileSiteKey = String(j.turnstile_site_key || "").trim();
          }
        }catch(e){}
      }

      async function loadData_(){
        var loadedAny = false;
        try{
          var r1 = await fetch("/assets/data/regions.json", { cache: "no-store" });
          var j1 = await r1.json();
          REGIONS = Array.isArray(j1 && j1.regions) ? j1.regions : [];
          loadedAny = loadedAny || !!REGIONS.length;

          var r2 = await fetch("/assets/data/experiences.json", { cache: "no-store" });
          var j2 = await r2.json();
          EXPERIENCES = Array.isArray(j2 && j2.experiences) ? j2.experiences : [];
          loadedAny = loadedAny || !!EXPERIENCES.length;
        }catch(e){}

        if(!loadedAny){
          showErr(t("load_failed"));
          return false;
        }
        return true;
      }

      function applyConfig_(){
        var form = qs("#eeForm");
        if(form && gasOnboardingUrl){
          form.setAttribute("action", gasOnboardingUrl);
        }
      }

      function resetForm(){
        var form = qs("#eeForm");
        if(form) form.reset();

        var loc = qs("#locationsBox");
        if(loc) loc.innerHTML = "";

        clearMessages();
        try{
          if(turnstileWidgetId !== null && window.turnstile){
            window.turnstile.reset(turnstileWidgetId);
          }
        }catch(e){}

        turnstileToken = "";
        var tokenField = qs("#turnstile_token");
        if(tokenField) tokenField.value = "";

        setText();
      }

      function boot(){
        setLang("es");
        bindTitleCase();

        document.addEventListener("change", function(e){
          var target = e.target;
          if(target && target.name === "regions"){ renderLocations(true); }
        });

        var btnReset = qs("#btnReset");
        if(btnReset){
          btnReset.addEventListener("click", function(){ resetForm(); });
        }

        var btnSubmit = qs("#btnSubmit");
        if(btnSubmit){
          btnSubmit.addEventListener("click", function(){
            if(!validate()){
              showErr(t("required_missing"));
              return;
            }

            if(turnstileSiteKey && !turnstileToken){
              showErr(t("security_missing"));
              return;
            }

            clearMessages();
            setSubmitting(true);

            window.__eeSubmitTimer = window.setTimeout(function(){
              setSubmitting(false);
              showErr(t("confirm_timeout"));
            }, 12000);

            var form = qs("#eeForm");
            if(form) form.submit();
          });
        }

        var sw = qs("#langSwitch");
        function toggle(){ setLang(lang === "es" ? "en" : "es"); }
        if(sw){
          sw.addEventListener("click", toggle);
          sw.addEventListener("keydown", function(e){
            if(e.key === "Enter" || e.key === " "){
              e.preventDefault();
              toggle();
            }
          });
        }

        window.addEventListener("message", function(ev){
          if(!ev || !ev.data) return;
          if(ev.data.type !== "EE_ONBOARDING_RESULT") return;

          if(window.__eeSubmitTimer){
            clearTimeout(window.__eeSubmitTimer);
            window.__eeSubmitTimer = null;
          }

          var payload = ev.data.payload || {};
          setSubmitting(false);

          if(payload.ok){
            showOk(t("success"));
            resetForm();
            window.scrollTo({ top: 0, behavior: "smooth" });
          } else {
            showErr(payload.error || "Submission failed.");
          }
        });

        (async function init(){
          await loadConfig_();
          applyConfig_();

          var ok = await loadData_();
          if(!ok) return;

          renderBusinessTypes();
          renderRegions(false);
          renderLocations(false);
          renderExperiences(false);

          await mountTurnstile_();
        })();
      }

      boot();
    })();
  </script>
</body>
</html>
